(function(e,t){function r(r,i,s){if(!r)return;t.isFunction(r)&&(r=r());if(r instanceof e.Model){var o=s?s+"_":"",u=t.extend({},r.attributes,r.obs||{});i["$"+(s||"model")]=function(){return n&&n.push([r,"change"]),r},t.each(u,function(e,s){i[o+s]=function(e){return n&&n.push([r,"change:"+s]),t.isUndefined(e)?r.get(s):t.isObject(e)&&!t.isArray(e)?r.set(e):r.set(s,e)}})}else r instanceof e.Collection&&(i["$"+(s||"collection")]=function(){return n&&n.push([r,"reset add remove sort"]),r});return r}function s(e){return t.isFunction(e)?e():(t.isObject(e)&&(e=t.isArray(e)?e.slice():t.clone(e),t.each(e,function(t,n){e[n]=s(t)})),e)}e.Epoxy=e.Epoxy||{};var n,i=e.Epoxy.View=e.View.extend({constructor:function(t){this._bind=[],e.View.prototype.constructor.apply(this,arguments),this.applyBindings()},bindings:"data-bind",applyBindings:function(){function u(t,n,r){try{e._bind.push(new a(t,n,s,i,this))}catch(o){throw'Error parsing bindings for "'+r+'" >> '+o}}this.removeBindings();if(!this.model&&!this.collection)return;var e=this,n=this.bindingSources,i=t.clone(o),s={};t.each(e.bindingHandlers||{},function(e,n){i[n]=t.isFunction(e)?{set:e}:e}),e.model=r(e.model,s),e.collection=r(e.collection,s),t.each(n,function(e,t){n[t]=r(e,s,t)});if(t.isObject(this.bindings))t.each(this.bindings,function(e,t){var n=this.$(t);this.$el.is(t)&&(n=n.add(this.$el)),n.length&&u(n,e,t)},this);else{var f=this.bindings,l="["+f+"]",c=this.$(l);this.$el.is(l)&&(c=c.add(this.$el)),c.each(function(e){e=$(this),u(e,e.attr(f),l)})}},removeBindings:function(){while(this._bind.length)this._bind.pop().dispose()},remove:function(){this.removeBindings(),e.View.prototype.remove.call(this)}}),o={attr:{set:function(e,t){e.attr(t)}},checked:{get:function(e,n){var r=!!e.prop("checked"),i=e.val();if(e.is(":radio"))return i;if(t.isArray(n)){n=n.slice();var s=t.indexOf(n,i);return r&&s<0?n.push(i):!r&&s>-1&&n.splice(s,1),n}return r},set:function(e,n){var r=!!n;e.is(":radio")?r=n==e.val():t.isArray(n)&&(r=t.contains(n,e.val())),e.prop("checked",r)}},classes:{set:function(e,n){t.each(n,function(t,n){e.toggleClass(n,!!t)})}},collection:{set:function(n,r,i){var s=e.Collection;if(!(r instanceof s&&t.isFunction(r.view)))throw"Binding 'collection:' requires a Collection with a 'view' constructor.";var o=r.models,u=this.v,a;i=i||r;if(i instanceof e.Model)if(!u.hasOwnProperty(i.cid)){u[i.cid]=a=new r.view({model:i});var f=t.indexOf(o,i);n.children().length<f?n.eq(f).before(a.$el):n.append(a.$el)}else a=u[i.cid],a.remove(),delete u[i.cid];else if(i instanceof s){var l=t.every(o,function(e){return u.hasOwnProperty(e.cid)});n.hide(),l?r.each(function(e){n.append(u[e.cid].$el)}):(this.empty(),r.each(function(e){u[e.cid]=a=new r.view({model:e}),n.append(a.$el)})),n.show()}}},css:{set:function(e,t){e.css(t)}},disabled:{set:function(e,t){e.prop("disabled",!!t)}},enabled:{set:function(e,t){e.prop("disabled",!t)}},html:{set:function(e,t){e.html(t)}},text:{set:function(e,t){e.text(t)}},toggle:{set:function(e,t){e.toggle(!!t)}},value:{get:function(e){return e.val()},set:function(e,t){e.val(t)}}},u={all:function(){var e=arguments;return function(){var t=!0;for(var n=0,r=e.length;n<r;n++)s(e[n])||(t=!1);return t}},any:function(){var e=arguments;return function(){var t=!1;for(var n=0,r=e.length;n<r;n++)s(e[n])&&(t=!0);return t}},none:function(){var e=arguments;return function(){var t=!0;for(var n=0,r=e.length;n<r;n++)s(e[n])&&(t=!1);return t}},not:function(e){return function(){return!s(e)}},format:function(){var e=arguments;return function(){var t=s(e[0]);for(var n=1,r=e.length;n<r;n++)t=t.replace("$"+n,s(e[n]));return t}},select:function(){var e=arguments;return function(){var t=s(e[0]),n=s(e[1]),r=s(e[2]);return t?n:r}}},a=function(e,r,i,o,a){this.$el=e,this.v={};var f=this,l=e[0].tagName.toLowerCase(),c=l=="input"||l=="select"||l=="textarea",h=new Function("$o","$a","with($o){with($a){return{"+r+"}}}"),p=["change"];r=h(u,i),r.events&&(p=t.isArray(r.events)?t.union(p,r.events):p,delete r.events),this.events=t.map(p,function(e){return e+".epoxy"}).join(" "),t.each(r,function(e,r){if(!o.hasOwnProperty(r))throw"invalid binding => "+r;var i=o[r],u=[];n=u,i.set.call(f,f.$el,s(e)),n=null,c&&i.get&&t.isFunction(e)&&f.$el.on(f.events,function(){e(i.get.call(f,f.$el,s(e)))});if(u.length){var a=function(t){i.set.call(f,f.$el,s(e),t)};for(var l=0,h=u.length;l<h;l++)f.listenTo(u[l][0],u[l][1],a)}})};t.extend(a.prototype,e.Events,{empty:function(){for(var e in this.v)this.v.hasOwnProperty(e)&&(e.remove(),delete this.v[e])},dispose:function(){this.empty(),this.stopListening(),this.$el.off(this.events),this.$el=null}})})(Backbone,_);