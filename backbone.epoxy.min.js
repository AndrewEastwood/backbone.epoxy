// Backbone.Epoxy 0.10.0
// (c) 2013 Greg MacWilliam
// Freely distributed under the MIT license
// http://epoxyjs.org
(function(){function t(t){return b(t)?t.slice():p(t)?u.clone(t):t}function e(t){return function(e,n,i){return t.prototype[n].apply(e,i)}}function n(t,e,i,s){for(var o in e)if(e.hasOwnProperty(o)){var r=e[o];if(t.hasObservable(o)){if(s.length&&!(0>u.indexOf(s,o)))throw"Recursive setter: "+s.join(" > ");r=t.obs[o].set(r),r&&p(r)&&(i=n(t,r,i,s.slice().concat([o])))}else i[o]=r}return i}function i(t,e,n){n=n||{},n.get&&g(n.get)&&(n._get=n.get),n.set&&g(n.set)&&(n._set=n.set),delete n.get,delete n.set,u.extend(this,n),this.model=t,this.name=e,this.deps=this.deps||[],t._init||this.init()}function s(t,e,n){if(t){if(g(t)&&(t=t()),m(t)){var i=n?n+"_":"",s=u.extend({},t.attributes,t.obs||{});e["$"+(n||"model")]=function(){return O&&O.push([t,"change"]),t},u.each(s,function(n,s){e[i+s]=function(e){return O&&O.push([t,"change:"+s]),v(e)?t.get(s):p(e)&&!b(e)?t.set(e):t.set(s,e)}})}else y(t)&&(e["$"+(n||"collection")]=function(){return O&&O.push([t,"reset add remove sort update"]),t});return t}}function o(t){return g(t)?t():(p(t)&&(t=b(t)?t.slice():u.clone(t),u.each(t,function(e,n){t[n]=o(e)})),t)}function r(t){var e=t,n=t;return p(t)&&(e=m(t)?t.get("label"):t.label,n=m(t)?t.get("value"):t.value),"<option value='"+n+"'>"+e+"</option>"}function h(t){return function(){var e=arguments;return function(){return t(e)}}}var a,c=this,l=c.Backbone,u=c._,f=l.Epoxy={},d=Array.prototype,v=u.isUndefined,g=u.isFunction,p=u.isObject,b=u.isArray,m=function(t){return t instanceof l.Model},y=function(t){return t instanceof l.Collection},w=e(l.Model);f.Model=l.Model.extend({constructor:function(){this.obs={},w(this,"constructor",arguments),this._init=!0,this.observableDefaults&&u.each(this.observableDefaults,function(e,n){this.addObservable(n,g(e)?e():t(e))},this),this.computeds&&u.each(this.computeds,function(t,e){this.addComputed(e,t)},this),u.each(this.obs,function(t){t.init()}),delete this._init},get:function(t){return a&&a.push([t,this]),this.hasObservable(t)?this.obs[t].get():w(this,"get",arguments)},getCopy:function(e){return t(this.get(e))},set:function(t,e,i){var s=t;return s&&!p(s)?(s={},s[t]=e):i=e,i=i||{},i.unset||(s=n(this,s,{},[])),w(this,"set",[s,i])},destroy:function(){return this.clearObservables(),w(this,"destroy",arguments)},addObservable:function(t,e){return this.removeObservable(t),this.obs[t]=new i(this,t,{value:e}),this},addComputed:function(t,e,n){this.removeObservable(t);var s=e;if(g(e)){var o=2;s={},s._get=e,g(n)&&(s._set=n,o++),s.deps=d.slice.call(arguments,o)}return this.obs[t]=new i(this,t,s),this},hasObservable:function(t){return this.obs.hasOwnProperty(t)},removeObservable:function(t){return this.hasObservable(t)&&(this.obs[t].dispose(),delete this.obs[t]),this},clearObservables:function(){for(var t in this.obs)this.removeObservable(t);return this},modifyArray:function(t,e){var n=this.get(t);if(b(n)&&g(d[e])){var i=d.slice.call(arguments,2),s=d[e].apply(n,i);return this.trigger("change change:"+t),s}return null},modifyObject:function(t,e,n){var i=this.get(t),s=!1;return p(i)?(v(n)&&i.hasOwnProperty(e)?(delete i[e],s=!0):i[e]!==n&&(i[e]=n,s=!0),s&&this.trigger("change change:"+t),i):null}}),u.extend(i.prototype,l.Events,{init:function(){if(a=this.deps,this.get(!0),a=null,this.deps.length){var t={};u.each(this.deps,function(e){var n=this.model;b(e)&&(n=e[1],e=e[0]),e.indexOf("change:")&&(e="change:"+e),t.hasOwnProperty(e)?u.contains(t[e],n)||t[e].push(n):t[e]=[n]},this),u.each(t,function(t,e){for(var n=0,i=t.length;i>n;n++)this.listenTo(t[n],e,u.bind(this.get,this,!0))},this)}},get:function(t){if(t===!0&&this._get){var e=this._get.call(this.model);this.change(e)}return this.value},set:function(t){if(this._get){if(this._set)return this._set.apply(this.model,arguments);throw"Cannot set read-only computed observable."}return this.change(t),null},fire:function(){this.model.trigger("change change:"+this.name)},change:function(t){u.isEqual(t,this.value)||(this.value=t,this.fire())},dispose:function(){this.stopListening(),this.off(),this.model=this.value=null}});var O,_=e(l.View);f.View=l.View.extend({constructor:function(){this._bind=[],_(this,"constructor",arguments),this.applyBindings()},bindings:"data-bind",applyBindings:function(){function t(t,n,i){try{e._bind.push(new C(t,n,r,o))}catch(s){throw'Error parsing bindings for "'+i+'" >> '+s}}if(this.removeBindings(),this.model||this.collection||this.bindingSources){var e=this,n=e.bindingSources,i=e.bindings,o=u.clone(x),r={};if(u.each(e.bindingHandlers||{},function(t,e){o[e]=g(t)?{set:t}:t}),e.model=s(e.model,r),e.collection=s(e.collection,r),u.each(n,function(t,e){n[e]=s(t,r,e)}),p(i))u.each(i,function(e,n){var i=this.$(n);this.$el.is(n)&&(i=i.add(this.$el)),i.length&&t(i,e,n)},this);else{var h="["+i+"]",a=this.$(h);this.$el.is(h)&&(a=a.add(this.$el)),a.each(function(e){e=$(this),t(e,e.attr(i),h)})}}},removeBindings:function(){for(;this._bind.length;)this._bind.pop().dispose()},remove:function(){this.removeBindings(),_(this,"remove")}});var x={attr:{set:function(t,e){t.attr(e)}},checked:{get:function(t,e){var n=!!t.prop("checked"),i=t.val();if(t.is(":radio"))return i;if(b(e)){e=e.slice();var s=u.indexOf(e,i);return n&&0>s?e.push(i):!n&&s>-1&&e.splice(s,1),e}return n},set:function(t,e){var n=!!e;t.is(":radio")?n=e==t.val():b(e)&&(n=u.contains(e,t.val())),t.prop("checked",n)}},classes:{set:function(t,e){u.each(e,function(e,n){t.toggleClass(n,!!e)})}},collection:{set:function(t,e,n){if(!y(e)||!g(e.view))throw"Binding 'collection' requires a Collection with a 'view' constructor.";var i,s=e.models,o=this.v;if(n=n||e,m(n))if(o.hasOwnProperty(n.cid))i=o[n.cid],i.remove(),delete o[n.cid];else{o[n.cid]=i=new e.view({model:n});var r=u.indexOf(s,n);r>t.children().length?t.eq(r).before(i.$el):t.append(i.$el)}else if(y(n)){var h=s.length&&u.every(s,function(t){return o.hasOwnProperty(t.cid)});t.hide(),h?e.each(function(e){t.append(o[e.cid].$el)}):(this.empty(),e.each(function(n){o[n.cid]=i=new e.view({model:n}),t.append(i.$el)})),t.show()}}},css:{set:function(t,e){t.css(e)}},disabled:{set:function(t,e){t.prop("disabled",!!e)}},enabled:{set:function(t,e){t.prop("disabled",!e)}},html:{set:function(t,e){t.html(e)}},options:{set:function(t,e){var n=o(this.optionsEmpty),i=o(this.optionsDefault),s=y(e)?e.models:e;if(!b(s))throw"Binding 'options' requires a list value.";var h=t.val(),a=!0,c="";s.length||i||!n?(i&&(c+=r(i)),u.each(s,function(t){c+=r(t)})):(c+=r(n),a=!1),t.html(c).prop("disabled",!a).val(h),u.isEqual(t.val(),h)||t.trigger("change")}},text:{set:function(t,e){t.text(e)}},toggle:{set:function(t,e){t.toggle(!!e)}},value:{get:function(t){return t.val()},set:function(t,e){t.val()!=e&&t.val(e)}}},E=["events","optionsDefault","optionsEmpty"],B={all:h(function(t){for(var e=!0,n=0,i=t.length;i>n;n++)o(t[n])||(e=!1);return e}),any:h(function(t){for(var e=!1,n=0,i=t.length;i>n;n++)o(t[n])&&(e=!0);return e}),length:h(function(t){return o(t[0]).length||0}),none:h(function(t){for(var e=!0,n=0,i=t.length;i>n;n++)o(t[n])&&(e=!1);return e}),not:h(function(t){return!o(t[0])}),format:h(function(t){for(var e=o(t[0]),n=1,i=t.length;i>n;n++)e=e.replace(RegExp("\\$"+n,"g"),o(t[n]));return e}),select:h(function(t){var e=o(t[0]),n=o(t[1]),i=o(t[2]);return e?n:i})},C=function(t,e,n,i){this.$el=t,this.v={};var s=this,r=t[0].tagName.toLowerCase(),h="input"==r||"select"==r||"textarea"==r,a=Function("$o","$c","with($o){with($c){return{"+e+"}}}");e=a(B,n),u.each(E,function(t){s[t]=e[t],delete e[t]}),this.events=u.map(u.union(this.events||[],["change"]),function(t){return t+".epoxy"}).join(" "),u.each(e,function(t,e){if(!i.hasOwnProperty(e))throw"invalid binding => "+e;var n=i[e],r=[],a=function(e){n.set.call(s,s.$el,o(t),e)};if(O=r,a(),O=null,h&&n.get&&g(t)&&s.$el.on(s.events,function(){t(n.get.call(s,s.$el,o(t)))}),r.length)for(var c=0,l=r.length;l>c;c++)s.listenTo(r[c][0],r[c][1],a)})};u.extend(C.prototype,l.Events,{empty:function(){for(var t in this.v)this.v.hasOwnProperty(t)&&(this.v[t].remove(),delete this.v[t])},dispose:function(){this.empty(),this.stopListening(),this.$el.off(this.events),this.$el=null}})}).call(this);