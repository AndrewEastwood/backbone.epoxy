// Backbone.Epoxy 0.11.0
// (c) 2013 Greg MacWilliam
// Freely distributed under the MIT license
// http://epoxyjs.org
(function(){function t(t){return function(e,n,i){return t.prototype[n].apply(e,i)}}function e(t,n,i,s){for(var o in n)if(n.hasOwnProperty(o)){var r=n[o];if(t.hasObservable(o)){if(s.length&&!(0>g.indexOf(s,o)))throw"Recursive setter: "+s.join(" > ");r=t.obs[o].set(r),r&&O(r)&&(i=e(t,r,i,s.slice().concat([o])))}else i[o]=r}return i}function n(t){return w(t)?t.slice():O(t)?g.clone(t):t}function i(t,e,n){n=n||{},n.get&&y(n.get)&&(n._get=n.get),n.set&&y(n.set)&&(n._set=n.set),delete n.get,delete n.set,g.extend(this,n),this.model=t,this.name=e,this.deps=this.deps||[],t._init||this.init()}function s(t){return y(t)?t():(O(t)&&(t=w(t)?t.slice():g.clone(t),g.each(t,function(e,n){t[n]=s(e)})),t)}function o(t){return function(){var e=arguments;return function(){return t.apply(this,r(e))}}}function r(t){for(var e=[],n=0,i=t.length;i>n;n++)e.push(s(t[n]));return e}function c(t,e,n){if(t){if(y(t)&&(t=t()),x(t)){var i=n?n+"_":"";e["$"+(n||"model")]=function(){return k&&k.push([t,"change"]),t},g.each(t.toJSON({obs:!0}),function(n,s){e[i+s]=function(e){return a(t,s,e)}})}else _(t)&&(e["$"+(n||"collection")]=function(){return k&&k.push([t,"reset add remove sort update"]),t});return t}}function a(t,e,n){return k&&k.push([t,"change:"+e]),m(n)?t.get(e):O(n)&&!w(n)?t.set(n):t.set(e,n)}function u(t,e){var n=t.$(e);return t.$el.is(e)&&(n=n.add(t.$el)),n}function h(t,e,n,i,s){try{var o=Function("$o","$c","with($o){with($c){return{"+n+"}}}")(S,i)}catch(r){throw"Error parsing bindings: "+n}var c=g.map(g.union(o.events||[],["change"]),function(t){return t+".epoxy"}).join(" ");g.each(o,function(n,r){s.hasOwnProperty(r)&&t._bind.push(new l(e,s[r],n,c,i,o))})}function l(t,e,n,i,o,r){var c=this,a=t[0].tagName.toLowerCase(),u="input"==a||"select"==a||"textarea"==a,h=[],l=function(t){c.set(c.$el,s(n),t)};if(c.$el=t,c.evt=i,g.extend(c,e),n=c.init(c.$el,s(n),o,r)||n,k=h,l(),k=null,u&&e.get&&y(n)&&c.$el.on(i,function(){n(c.get(c.$el,s(n)))}),h.length)for(var f=0,d=h.length;d>f;f++)c.listenTo(h[f][0],h[f][1],l)}var f,d=this,v=d.Backbone,g=d._,p=v.Epoxy={},b=Array.prototype,m=g.isUndefined,y=g.isFunction,O=g.isObject,w=g.isArray,x=function(t){return t instanceof v.Model},_=function(t){return t instanceof v.Collection},C=function(){},E=t(v.Model);p.Model=v.Model.extend({constructor:function(){this.obs={},E(this,"constructor",arguments),this._init=!0,this.observableDefaults&&g.each(this.observableDefaults,function(t,e){this.addObservable(e,y(t)?t():n(t))},this),this.computeds&&g.each(this.computeds,function(t,e){this.addComputed(e,t)},this),g.each(this.obs,function(t){t.init()}),delete this._init},get:function(t){return f&&f.push([t,this]),this.hasObservable(t)?this.obs[t].get():E(this,"get",arguments)},getCopy:function(t){return n(this.get(t))},set:function(t,n,i){var s=t;return s&&!O(s)?(s={},s[t]=n):i=n,i=i||{},i.unset||(s=e(this,s,{},[])),E(this,"set",[s,i])},toJSON:function(t){var e=E(this,"toJSON",arguments);return t&&t.obs&&g.each(this.obs,function(t,n){e[n]=t.value}),e},destroy:function(){return this.clearObservables(),E(this,"destroy",arguments)},addObservable:function(t,e){return this.removeObservable(t),this.obs[t]=new i(this,t,{value:e}),this},addComputed:function(t,e,n){this.removeObservable(t);var s=e;if(y(e)){var o=2;s={},s._get=e,y(n)&&(s._set=n,o++),s.deps=b.slice.call(arguments,o)}return this.obs[t]=new i(this,t,s),this},hasObservable:function(t){return this.obs.hasOwnProperty(t)},removeObservable:function(t){return this.hasObservable(t)&&(this.obs[t].dispose(),delete this.obs[t]),this},clearObservables:function(){for(var t in this.obs)this.removeObservable(t);return this},modifyArray:function(t,e){var n=this.get(t);if(w(n)&&y(b[e])){var i=b.slice.call(arguments,2),s=b[e].apply(n,i);return this.trigger("change change:"+t),s}return null},modifyObject:function(t,e,n){var i=this.get(t),s=!1;return O(i)?(m(n)&&i.hasOwnProperty(e)?(delete i[e],s=!0):i[e]!==n&&(i[e]=n,s=!0),s&&this.trigger("change change:"+t),i):null}}),g.extend(i.prototype,v.Events,{init:function(){if(f=this.deps,this.get(!0),f=null,this.deps.length){var t={};g.each(this.deps,function(e){var n=this.model;w(e)&&(n=e[1],e=e[0]),e.indexOf("change:")&&(e="change:"+e),t.hasOwnProperty(e)?g.contains(t[e],n)||t[e].push(n):t[e]=[n]},this),g.each(t,function(t,e){for(var n=0,i=t.length;i>n;n++)this.listenTo(t[n],e,g.bind(this.get,this,!0))},this)}},get:function(t){if(t===!0&&this._get){var e=this._get.call(this.model);this.change(e)}return this.value},set:function(t){if(this._get){if(this._set)return this._set.apply(this.model,arguments);throw"Cannot set read-only computed observable."}return this.change(t),null},fire:function(){this.model.trigger("change change:"+this.name)},change:function(t){g.isEqual(t,this.value)||(this.value=t,this.fire())},dispose:function(){this.stopListening(),this.off(),this.model=this.value=null}});var P={optionText:"label",optionValue:"value"},B={attr:{set:function(t,e){t.attr(e)}},checked:{get:function(t,e){var n=!!t.prop("checked"),i=t.val();if(t.is(":radio"))return i;if(w(e)){e=e.slice();var s=g.indexOf(e,i);return n&&0>s?e.push(i):!n&&s>-1&&e.splice(s,1),e}return n},set:function(t,e){var n=!!e;t.is(":radio")?n=e==t.val():w(e)&&(n=g.contains(e,t.val())),t.prop("checked",n)}},classes:{set:function(t,e){g.each(e,function(e,n){t.toggleClass(n,!!e)})}},collection:{init:function(t,e){if(!_(e)||!y(e.view))throw"Binding 'collection' requires a Collection with a 'view' constructor.";this.v={}},set:function(t,e,n){var i,s=e.models,o=this.v;if(n=n||e,x(n))if(o.hasOwnProperty(n.cid))i=o[n.cid],i.remove(),delete o[n.cid];else{o[n.cid]=i=new e.view({model:n});var r=g.indexOf(s,n);r>t.children().length?t.eq(r).before(i.$el):t.append(i.$el)}else if(_(n)){var c=s.length&&g.every(s,function(t){return o.hasOwnProperty(t.cid)});t.hide(),c?e.each(function(e){t.append(o[e.cid].$el)}):(this.clean(),e.each(function(n){o[n.cid]=i=new e.view({model:n}),t.append(i.$el)})),t.show()}},clean:function(){for(var t in this.v)this.v.hasOwnProperty(t)&&(this.v[t].remove(),delete this.v[t])}},css:{set:function(t,e){t.css(e)}},disabled:{set:function(t,e){t.prop("disabled",!!e)}},enabled:{set:function(t,e){t.prop("disabled",!e)}},html:{set:function(t,e){t.html(e)}},options:{init:function(t,e,n,i){this.e=i.optionsEmpty,this.d=i.optionsDefault,this.v=i.value},set:function(t,e){var n=this,i=s(n.e),o=s(n.d),r=s(n.v),c=w(r)?r:[r],a=_(e)?e.models:e,u=a.length,h=!0,l="";u||o||!i?(o&&(a=[o].concat(a)),g.each(a,function(t){l+=n.opt(t,u,c)})):(l+=n.opt(i,u,c),h=!1),t.html(l).prop("disabled",!h);var f=t.val();n.v&&!g.isEqual(r,f)&&n.v(f)},opt:function(t,e,n){var i=t,s=t,o=P.optionText,r=P.optionValue;O(t)&&(i=x(t)?t.get(o):t[o],s=x(t)?t.get(r):t[r]);var c=!e||g.contains(n,s)?"' selected='selected'>":"'>";return"<option value='"+s+c+i+"</option>"},clean:function(){this.d=this.e=this.v=null}},template:{init:function(t,e,n){var i=t.find("script,template");return this.tmpl=g.template(i.length?i.html():t.html()),w(e)?g.pick(n,e):void 0},set:function(t,e){e=x(e)?e.toJSON({obs:!0}):e,t.html(this.tmpl(e))},clean:function(){this.tmpl=null}},text:{set:function(t,e){t.text(e)}},toggle:{set:function(t,e){t.toggle(!!e)}},value:{get:function(t){return t.val()},set:function(t,e){try{t.val()!=e&&t.val(e)}catch(n){}}}},S={all:o(function(){for(var t=arguments,e=0,n=t.length;n>e;e++)if(!t[e])return!1;return!0}),any:o(function(){for(var t=arguments,e=0,n=t.length;n>e;e++)if(t[e])return!0;return!1}),length:o(function(t){return t.length||0}),none:o(function(){for(var t=arguments,e=0,n=t.length;n>e;e++)if(t[e])return!1;return!0}),not:o(function(t){return!t}),format:o(function(t){for(var e=arguments,n=1,i=e.length;i>n;n++)t=t.replace(RegExp("\\$"+n,"g"),e[n]);return t}),select:o(function(t,e,n){return t?e:n})};p.binding={addHandler:function(t,e){B[t]=y(e)?{set:e}:e},addOperator:function(t,e){S[t]=o(e)},config:function(t){g.extend(P,t)}};var k,N=t(v.View);p.View=v.View.extend({constructor:function(){this._bind=[],N(this,"constructor",arguments),this.applyBindings()},bindings:"data-bind",applyBindings:function(){if(this.removeBindings(),this.model||this.collection||this.bindingSources){var t=this,e=t.bindingSources,n=t.bindings,i=g.clone(B),s={};g.each(t.bindingHandlers||{},function(t,e){i[e]=y(t)?{set:t}:t}),t.model=c(t.model,s),t.collection=c(t.collection,s),g.each(e,function(t,n){e[n]=c(t,s,n)}),O(n)?g.each(n,function(e,n){var o=u(t,n);o.length&&h(t,o,e,s,i)}):u(t,"["+n+"]").each(function(){var e=$(this);h(t,e,e.attr(n),s,i)})}},removeBindings:function(){for(;this._bind.length;)this._bind.pop().dispose()},remove:function(){this.removeBindings(),N(this,"remove")}}),g.extend(l.prototype,v.Events,{init:C,get:C,set:C,clean:C,dispose:function(){this.clean(),this.stopListening(),this.$el.off(this.evt),this.$el=null}})}).call(this);