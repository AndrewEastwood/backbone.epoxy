(function(e,t){e.Epoxy={};var n=e.Epoxy.Model=e.Model.extend({_super:function(t,n){return e.Model.prototype[t].apply(this,n)},constructor:function(){this._cmp={},this._super("constructor",arguments),this.computed&&t.each(this.computed,function(e,t){this.addComputed(t,e)},this)},get:function(e){n._map&&n._map.push([e,this]);if(this.hasComputed(e)){var t=this._cmp[e];if(t.virtual)return t.value}return this._super("get",arguments)},set:function(e,n,r){var i=e;return typeof i!="object"?(i={},i[e]=n):r=n,r=r||{},r.unset||t.each(i,function(e,n){if(this.hasComputed(n)){if(!this.hasWritable(n))throw"Cannot set readonly property: "+n;delete i[n],t.extend(i,this._cmp[n].set.call(this,e))}},this),this._super("set",[i,r])},destroy:function(){return this.clearComputed(),this._super("destroy",arguments)},addObservable:function(){},addComputed:function(e,t,r){this.removeComputed(e);var i=t;if(typeof t=="function"){var s=2;i={},i.get=t,typeof r=="function"&&(i.set=r,s++),i.deps=Array.prototype.slice.call(arguments,s)}this._cmp[e]=new n.ComputedObservable(e,i,this)},removeComputed:function(e){this.hasComputed(e)&&(this._cmp[e].dispose(),delete this._cmp[e])},hasComputed:function(e){return this._cmp.hasOwnProperty(e)},hasWritable:function(e){var t=this._cmp[e];return t&&typeof t.set=="function"},clearComputed:function(){for(var e in this._cmp)this.removeComputed(e)}}),r=n.Observable=function(e,t){this.name=e,this.set(t,!0)};t.extend(r.prototype,e.Events,{value:undefined,previous:undefined,get:function(){return this.value},set:function(e,t){if(e!==this.value||t)this.previous=this.value,this.value=e,this.change()},change:function(){this.trigger("change change:"+this.name)},dispose:function(){this.off(),this.stopListening(),this.value=this.previous=null}}),r.extend=e.Model.extend,n.ArrayObservable=r.extend({set:function(e,t){t=t||this.value.length!==e.length;if(!t)for(var n=0,r=e.length;n<r;n++)if(this.value[n]!==e[n]){t=!0;break}t&&(this.previous=this.value,this.value=e,this.change())},_op:function(e,t){var n=Array.prototype[e].apply(this.value,t);this.change();return},pop:function(){return this._op("pop",arguments)},push:function(){return this._op("push",arguments)},reverse:function(){return this._op("reverse",arguments)},shift:function(){return this._op("shift",arguments)},slice:function(){return this._op("slice",arguments)},sort:function(){return this._op("sort",arguments)},unshift:function(){return this._op("unshift",arguments)}}),n.ComputedObservable=r.extend({deps:null,virtual:!0,constructor:function(e,r,i){t.extend(this,r||{}),this.model=i,this.name=e,this.deps=this.deps||[],n._map=this.deps,this.update(),this.bindings(),n._map=null},update:function(){this.previous=this.value,this.value=this.get.call(this.model);var e=this.value!==this.previous;this.virtual?e&&this.model.trigger("change change:"+this.name):this.model._super("set",[this.name,this.value])},bindings:function(){var e={};t.each(this.deps,function(n){var r=this.model;n instanceof Array&&(r=n[1],n=n[0]),!n.indexOf("change:")||(n="change:"+n),e.hasOwnProperty(n)?t.contains(e[n],r)||e[n].push(r):e[n]=[r]},this),t.each(e,function(e,t){for(var n=0,r=e.length;n<r;n++)this.listenTo(e[n],t,this.update)},this)},dispose:function(){this.stopListening(),this.virtual||this.model.unset(this.name),this.model=null}}),e.Epoxy.defaultBindings={attr:{set:function(e,t){e.attr(t)}},checked:{get:function(e){return e.is(":radio")?e.val():!!e.prop("checked")},set:function(e,t){var n=e.is(":radio")?t==e.val():!!t;e.prop("checked",n)}},className:{set:function(e,n){t.each(n,function(t,n){e.toggleClass(n,!!t)})}},css:{set:function(e,t){e.css(t)}},disabled:{set:function(e,t){e.prop("disabled",!!t)}},enabled:{set:function(e,t){e.prop("disabled",!t)}},html:{set:function(e,t){e.html(t)}},text:{set:function(e,t){e.text(t)}},toggle:{set:function(e,t){e.toggle(!!t)}},value:{get:function(e){return e.val()},set:function(e,t){e.val(t)}}};var i=e.Epoxy.View=e.View.extend({constructor:function(t){this._pox=[],t&&t.template&&(this.template=t.template);if(this.template){var n=this.template;n=typeof n=="function"?n():n,this.el=this.$el=$(n)}e.View.prototype.constructor.call(this,arguments)},bindView:function(){function u(e,t,u){try{o._pox.push(new i.Binding(e,t,r,n,s))}catch(a){throw'Error parsing bindings for "'+u+'": '+a}}this.unbindView();if(!this.model||!this.bindings)return;var n=t.extend(this.operators||{},e.Epoxy.defaultBindings),r={},s=this.model,o=this;t.each(t.extend({},s.attributes,s._cmp||{}),function(e,t){r[t]=function(e){return i._map&&i._map.push("change:"+t),e!==undefined?typeof e=="object"?s.set(e):s.set(t,e):s.get(t)}});if(typeof this.bindings=="object")t.each(this.bindings,function(e,t){var n=this.$(t);n.length&&u(n,e,t)},this);else{var a=this.bindings;this.$("["+a+"]").each(function(){var e=$(this);u(e,e.attr(a),e.attr("class"))})}},unbindView:function(){while(this._pox.length)this._pox.pop().dispose()},remove:function(){this.unbindView(),e.View.prototype.remove.call(this)}});i.Binding=function(e,n,r,s,o){this.$el=e,this.accessors=r,this.parser=new Function("$context","with($context){return{"+n+"}}"),this.parse();var u=this,a=e[0].tagName.toLowerCase(),f=a=="input"||a=="select"||a=="textarea";t.each(u.bindings,function(e,t){if(!s.hasOwnProperty(t))throw"invalid binding => "+n;var n=s[t],r=[];i._map=r,u.dirty=!1,n.set.call(u,u.$el,u.read(e)),i._map=null;var a=u.dirty;f&&n.get&&typeof e=="function"&&u.$el.on(u.events,function(){e(n.get.call(u,u.$el))}),r.length&&u.listenTo(o,r.join(" "),function(){a&&(e=u.parse(t)),n.set.call(u,u.$el,u.read(e))})})},i.Binding.prototype=t.extend({dirty:!1,events:"change.epoxy",accessors:{},bindings:{},parse:function(e){var n=this.bindings=this.parser(this.accessors);if(n.events){var r=n.events;r instanceof Array&&(t.indexOf(r,"change")<0&&r.push("change"),this.events=t.map(r,function(e){return e+".epoxy"}).join(" ")),delete n.events}if(e)return n[e]},read:function(e){var n=typeof e;return n=="function"?e():n=="object"?(e=t.clone(e),t.each(e,function(t,n){e[n]=this.read(t)},this),e):(this.dirty=!0,e)},dispose:function(){this.stopListening(),this.$el.off(this.events),this.$el=null}},e.Events)})(Backbone,_);