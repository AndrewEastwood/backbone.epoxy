(function(e,t){function s(e){return t.isFunction(e)?e():(t.isObject(e)&&(e=t.isArray(e)?e.slice():t.clone(e),t.each(e,function(t,n){e[n]=s(t)})),e)}e.Epoxy={};var n=e.Epoxy.Model=e.Model.extend({_super:function(t,n){return e.Model.prototype[t].apply(this,n)},constructor:function(){this.obs={},this._super("constructor",arguments),this._init=!0,this.virtuals&&t.each(this.virtuals,function(e,t){this.addVirtual(t,e)},this),this.computeds&&t.each(this.computeds,function(e,t){this.addComputed(t,e)},this),t.each(this.obs,function(e,t){e.init()}),delete this._init},get:function(e){return n._map&&n._map.push([e,this]),this.hasVirtual(e)?this.obs[e].get():this._super("get",arguments)},set:function(e,t,n){var r=e;return r&&typeof r!="object"?(r={},r[e]=t):n=t,n=n||{},n.unset||(r=this._deepset(r,{},[])),this._super("set",[r,n])},_deepset:function(e,n,r){for(var i in e)if(e.hasOwnProperty(i)){var s=e[i];if(this.hasVirtual(i)){if(!(!r.length||t.indexOf(r,i)<0))throw"Recursive setter: "+r.join(" > ");s=this.obs[i].set(s),s&&typeof s=="object"&&(n=this._deepset(s,n,r.slice().concat([i])))}else n[i]=s}return n},destroy:function(){return this.clearVirtuals(),this._super("destroy",arguments)},addVirtual:function(e,t){this.removeVirtual(e),this.obs[e]=new n.VirtualProperty(this,e,{value:t})},addComputed:function(e,r,i){this.removeVirtual(e);var s=r;if(t.isFunction(r)){var o=2;s={},s._get=r,t.isFunction(i)&&(s._set=i,o++),s.deps=Array.prototype.slice.call(arguments,o)}this.obs[e]=new n.VirtualProperty(this,e,s)},removeVirtual:function(e){this.hasVirtual(e)&&(this.obs[e].dispose(),delete this.obs[e])},hasVirtual:function(e){return this.obs.hasOwnProperty(e)},clearVirtuals:function(){for(var e in this.obs)this.removeVirtual(e)}}),r=n.VirtualProperty=function(e,n,r){r=r||{},r.get&&t.isFunction(r.get)&&(r._get=r.get),r.set&&t.isFunction(r.set)&&(r._set=r.set),delete r.get,delete r.set,t.extend(this,r),this.model=e,this.name=n,this.deps=this.deps||[],this.bindCustom(),e._init||this.init()};t.extend(r.prototype,e.Events,{deps:undefined,value:undefined,custom:undefined,init:function(){n._map=this.deps,this.update(),n._map=null;if(this.deps.length){var e={};t.each(this.deps,function(n){var r=this.model;t.isArray(n)&&(r=n[1],n=n[0]),!n.indexOf("change:")||(n="change:"+n),e.hasOwnProperty(n)?t.contains(e[n],r)||e[n].push(r):e[n]=[r]},this),t.each(e,function(e,t){for(var n=0,r=e.length;n<r;n++)this.listenTo(e[n],t,this.update)},this)}},get:function(e){if(e&&this._get){var t=this._get.call(this.model);this.change(t)}return this.copy()},set:function(e){if(this._get){if(this._set)return this._set.apply(this.model,arguments);throw"Cannot set read-only computed observable."}return this.change(e),null},update:function(){this.get(!0)},fire:function(){this.model.trigger("change change:"+this.name)},copy:function(){var e=this.value;return this.custom?this.custom:t.isArray(e)?e.slice():t.isObject(e)?t.clone(e):e},change:function(e){t.isEqual(e,this.value)||(this.value=e,this.bindCustom(),this.fire())},bindCustom:function(){var n=this.custom,r=this.value;n&&n!==r&&(this.stopListening(n),this.custom=null),r instanceof e.Collection&&(n=this.custom=r,this.listenTo(n,"add remove reset sort",this.fire),this.listenTo(n,"destroy",t.bind(this.model.removeVirtual,this.model,this.name)))},isArray:function(){return t.isArray(this.value)},modifyArray:function(e){var n=Array.prototype;if(this.isArray()&&t.isFunction(n[e])){var r=n.slice.call(arguments,1),i=n[e].apply(this.value,r);return this.fire(),i}return null},dispose:function(){this.stopListening(),this.off(),this.model=this.value=this.collection=null}});var i=e.Epoxy.View=e.View.extend({constructor:function(t){this._xv=[],e.View.prototype.constructor.call(this,arguments)},bindView:function(){function a(e,t,i){try{o._xv.push(new u(e,t,r,n,s))}catch(a){throw'Error parsing bindings for "'+i+'" >> '+a}}this.unbindView();if(!this.model||!this.bindings)return;var n=t.extend({},e.Epoxy.defaultBindings,this.operators||{}),r={},s=this.model,o=this;t.each(t.extend({},s.attributes,s.obs||{}),function(e,n){r[n]=function(e){return i._map&&i._map.push("change:"+n),t.isUndefined(e)?s.get(n):e&&t.isObject(e)&&!t.isArray(e)?s.set(e):s.set(n,e)}});if(this.bindings&&typeof this.bindings=="object")t.each(this.bindings,function(e,t){var n=this.$(t);this.$el.is(t)&&(n=n.add(this.$el)),n.length&&a(n,e,t)},this);else{var f=this.bindings,l="["+f+"]",c=this.$(l);this.$el.is(l)&&(c=c.add(this.$el)),c.each(function(e){e=$(this),a(e,e.attr(f),l)})}},unbindView:function(){while(this._xv.length)this._xv.pop().dispose()},remove:function(){this.unbindView(),e.View.prototype.remove.call(this)}});e.Epoxy.defaultBindings={attr:{set:function(e,t){e.attr(t)}},checked:{get:function(e,n){var r=!!e.prop("checked"),i=e.val();if(e.is(":radio"))return i;if(t.isArray(n)){var s=t.indexOf(n,i);return r&&s<0?n.push(i):!r&&s>-1&&n.splice(s,1),n}return r},set:function(e,n){var r=!!n;e.is(":radio")?r=n==e.val():t.isArray(n)&&(r=t.contains(n,e.val())),e.prop("checked",r)}},className:{set:function(e,n){t.each(n,function(t,n){e.toggleClass(n,!!t)})}},collection:{set:function(n,r){if(!(r instanceof e.Collection&&t.isFunction(r.view)))throw"Binding 'collection:' requires a Backbone.Collection with a '.view' property.";var i=$("<div/>");n.empty(),r.each(function(e,t){e.view||(e.view=new r.view({model:e})),i.append(e.view.$el)}),n.append(i.children())}},css:{set:function(e,t){e.css(t)}},disabled:{set:function(e,t){e.prop("disabled",!!t)}},enabled:{set:function(e,t){e.prop("disabled",!t)}},html:{set:function(e,t){e.html(t)}},text:{set:function(e,t){e.text(t)}},toggle:{set:function(e,t){e.toggle(!!t)}},value:{get:function(e){return e.val()},set:function(e,t){e.val(t)}}};var o={all:function(){var e=arguments;return function(){var t=!0;for(var n=0,r=e.length;n<r;n++)s(e[n])||(t=!1);return t}},any:function(){var e=arguments;return function(){var t=!1;for(var n=0,r=e.length;n<r;n++)s(e[n])&&(t=!0);return t}},none:function(){var e=arguments;return function(){var t=!0;for(var n=0,r=e.length;n<r;n++)s(e[n])&&(t=!1);return t}},not:function(e){return function(){return!s(e)}},parse:function(){var e=arguments;return function(){var t=e[0];for(var n=1,r=e.length;n<r;n++)t=t.replace("$"+n,s(e[n]));return t}}},u=function(e,n,r,u,a){this.$el=e;var f=this,l=e[0].tagName.toLowerCase(),c=l=="input"||l=="select"||l=="textarea",h=new Function("$f","$a","with($f){with($a){return{"+n+"}}}"),p=["change"];n=h(o,r),n.events&&(p=t.isArray(n.events)?t.union(p,n.events):p,delete n.events),this.events=t.map(p,function(e){return e+".epoxy"}).join(" "),t.each(n,function(e,n){if(!u.hasOwnProperty(n))throw"invalid binding => "+r;var r=u[n],o=[];i._map=o,r.set.call(f,f.$el,s(e)),i._map=null,c&&r.get&&t.isFunction(e)&&f.$el.on(f.events,function(){e(r.get.call(f,f.$el,s(e)))}),o.length&&f.listenTo(a,o.join(" "),function(){r.set.call(f,f.$el,s(e))})})};t.extend(u.prototype,e.Events,{events:"",dispose:function(){this.stopListening(),this.$el.off(this.events),this.$el=null}})})(Backbone,_);