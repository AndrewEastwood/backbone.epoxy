(function(e,t){e.Epoxy={};var n=e.Epoxy.Model=e.Model.extend({_super:function(t,n){return e.Model.prototype[t].apply(this,n)},constructor:function(){this._cmp={},this._super("constructor",arguments),this.computed&&t.each(this.computed,function(e,t){this.addComputed(t,e)},this)},get:function(e){n._map&&n._map.push([e,this]);if(this.hasComputed(e)){var t=this._cmp[e];if(t.virtual)return t.value}return this._super("get",arguments)},set:function(e,n,r){var i=e;return typeof i!="object"?(i={},i[e]=n):r=n,r=r||{},r.unset||t.each(i,function(e,n){if(this.hasComputed(n)){if(!this.hasWritable(n))throw"Cannot set readonly property: "+n;delete i[n],t.extend(i,this._cmp[n].set.call(this,e))}},this),this._super("set",[i,r])},destroy:function(){return this.clearComputed(),this._super("destroy",arguments)},addComputed:function(e,t){this.removeComputed(e);var r=Array.prototype.slice.call(arguments,2);this._cmp[e]=new n.Computed(this,e,t,r)},removeComputed:function(e){this.hasComputed(e)&&(this._cmp[e].dispose(),delete this._cmp[e])},hasComputed:function(e){return this._cmp.hasOwnProperty(e)},hasWritable:function(e){var t=this._cmp[e];return t&&typeof t.set=="function"},clearComputed:function(){for(var e in this._cmp)this.removeComputed(e)}});n.Computed=function(e,r,i,s){typeof i=="function"?this.get=i:t.extend(this,i),this.name=r,this.model=e,this.deps=this.deps||[],s&&(this.deps=this.deps.concat(s)),n._map=this.deps,this.update(),this.bindings(),n._map=null},n.Computed.prototype=t.extend({name:"",value:null,previous:null,virtual:!1,get:null,set:null,bindings:function(){var e={};t.each(this.deps,function(n){var r=this.model;n instanceof Array&&(r=n[1],n=n[0]),!n.indexOf("change:")||(n="change:"+n),e.hasOwnProperty(n)?t.contains(e[n],r)||e[n].push(r):e[n]=[r]},this),t.each(e,function(e,t){for(var n=0,r=e.length;n<r;n++)this.listenTo(e[n],t,this.update)},this)},update:function(){this.previous=this.value,this.value=this.get.call(this.model);var e=this.value!==this.previous;this.virtual?e&&this.model.trigger("change change:"+this.name):this.model._super("set",[this.name,this.value])},dispose:function(){this.stopListening(),this.virtual||this.model.unset(this.name),this.model=null}},e.Events),e.Epoxy.defaultBindings={attr:{set:function(e,t){e.attr(t)}},checked:{get:function(e){return e.is(":radio")?e.val():!!e.prop("checked")},set:function(e,t){var n=e.is(":radio")?t==e.val():!!t;e.prop("checked",n)}},className:{set:function(e,n){t.each(n,function(t,n){e.toggleClass(n,!!t)})}},css:{set:function(e,t){e.css(t)}},enabled:{set:function(e,t){e.prop("disabled",!!t)}},html:{set:function(e,t){e.html(t)}},text:{set:function(e,t){e.text(t)}},toggle:{set:function(e,t){e.toggle(!!t)}},value:{get:function(e){return e.val()},set:function(e,t){e.val(t)}}};var r=e.Epoxy.View=e.View.extend({constructor:function(t){this._bound=[],t&&t.template&&(this.template=t.template);if(this.template){var n=this.template;n=typeof n=="function"?n():n,this.el=this.$el=$(n)}e.View.prototype.constructor.call(this,arguments)},bindView:function(){function u(e,t,u){try{o._bound.push(new r.Binding(e,t,i,n,s))}catch(a){throw'Error parsing bindings for "'+u+'": '+a}}this.unbindView();if(!this.model||!this.bindings)return;var n=t.extend(this.operators||{},e.Epoxy.defaultBindings),i={},s=this.model,o=this;t.each(t.extend({},s.attributes,s._cmp||{}),function(e,t){i[t]=function(e){return r._map&&r._map.push("change:"+t),e!==undefined?typeof e=="object"?s.set(e):s.set(t,e):s.get(t)}});if(typeof this.bindings=="object")t.each(this.bindings,function(e,t){var n=this.$(t);n.length&&u(n,e,t)},this);else{var a=this.bindings;this.$("["+a+"]").each(function(){var e=$(this);u(e,e.attr(a),e.attr("class"))})}},unbindView:function(){while(this._bound.length)this._bound.pop().dispose()},remove:function(){this.unbindView(),e.View.prototype.remove.call(this)}});r.Binding=function(e,n,i,s,o){this.$el=e,this.accessors=i,this.parser=new Function("$context","with($context){return{"+n+"}}"),this.parse();var u=this,a=e[0].tagName.toLowerCase(),f=a=="input"||a=="select"||a=="textarea";t.each(u.bindings,function(e,t){if(!s.hasOwnProperty(t))throw"invalid binding => "+n;var n=s[t],i=[];r._map=i,u.dirty=!1,n.set.call(u,u.$el,u.read(e)),r._map=null;var a=u.dirty;f&&n.get&&typeof e=="function"&&u.$el.on(u.events,function(){e(n.get.call(u,u.$el))}),i.length&&u.listenTo(o,i.join(" "),function(){a&&(e=u.parse(t)),n.set.call(u,u.$el,u.read(e))})})},r.Binding.prototype=t.extend({dirty:!1,events:"change.epoxy",accessors:{},bindings:{},parse:function(e){var n=this.bindings=this.parser(this.accessors);if(n.events){var r=n.events;r instanceof Array&&(t.contains(r,"change")||r.push("change"),this.events=t.map(r,function(e){return e+".epoxy"}).join(" ")),delete n.events}if(e)return n[e]},read:function(e){var n=typeof e;return n=="function"?e():n=="object"?(e=t.clone(e),t.each(e,function(t,n){e[n]=this.read(t)},this),e):(this.dirty=!0,e)},dispose:function(){this.stopListening(),this.$el.off(this.events),this.$el=null}},e.Events)})(Backbone,_);