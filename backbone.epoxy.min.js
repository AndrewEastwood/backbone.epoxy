// Backbone.Epoxy 0.10.1
// (c) 2013 Greg MacWilliam
// Freely distributed under the MIT license
// http://epoxyjs.org
(function(t,e){var n="backbone",i="underscore";"undefined"!=typeof exports?module.exports=e(require(i),require(n)):"function"==typeof define&&define.amd?define([i,n],e):e(t._,t.Backbone)})(this,function(t,e){function n(e){return v(e)?e.slice():d(e)?t.clone(e):e}function i(t){return function(e,n,i){return t.prototype[n].apply(e,i)}}function s(e,n,i,o){for(var r in n)if(n.hasOwnProperty(r)){var a=n[r];if(e.hasObservable(r)){if(o.length&&!(0>t.indexOf(o,r)))throw"Recursive setter: "+o.join(" > ");a=e.obs[r].set(a),a&&d(a)&&(i=s(e,a,i,o.slice().concat([r])))}else i[r]=a}return i}function o(e,n,i){if(e){if(f(e)&&(e=e()),g(e)){var s=i?i+"_":"",o=t.extend({},e.attributes,e.obs||{});n["$"+(i||"model")]=function(){return y&&y.push([e,"change"]),e},t.each(o,function(t,i){n[s+i]=function(t){return y&&y.push([e,"change:"+i]),l(t)?e.get(i):d(t)&&!v(t)?e.set(t):e.set(i,t)}})}else p(e)&&(n["$"+(i||"collection")]=function(){return y&&y.push([e,"reset add remove sort update"]),e});return e}}function r(e){return f(e)?e():(d(e)&&(e=v(e)?e.slice():t.clone(e),t.each(e,function(t,n){e[n]=r(t)})),e)}function a(t){var e=t,n=t;return d(t)&&(e=g(t)?t.get("label"):t.label,n=g(t)?t.get("value"):t.value),"<option value='"+n+"'>"+e+"</option>"}var c,h=e.Epoxy={},u=Array.prototype,l=t.isUndefined,f=t.isFunction,d=t.isObject,v=t.isArray,g=function(t){return t instanceof e.Model},p=function(t){return t instanceof e.Collection},b=i(e.Model);h.Model=e.Model.extend({constructor:function(){this.obs={},b(this,"constructor",arguments),this._init=!0,this.observableDefaults&&t.each(this.observableDefaults,function(t,e){this.addObservable(e,f(t)?t():n(t))},this),this.computeds&&t.each(this.computeds,function(t,e){this.addComputed(e,t)},this),t.each(this.obs,function(t){t.init()}),delete this._init},get:function(t){return c&&c.push([t,this]),this.hasObservable(t)?this.obs[t].get():b(this,"get",arguments)},getCopy:function(t){return n(this.get(t))},set:function(t,e,n){var i=t;return i&&!d(i)?(i={},i[t]=e):n=e,n=n||{},n.unset||(i=s(this,i,{},[])),b(this,"set",[i,n])},destroy:function(){return this.clearObservables(),b(this,"destroy",arguments)},addObservable:function(t,e){return this.removeObservable(t),this.obs[t]=new m(this,t,{value:e}),this},addComputed:function(t,e,n){this.removeObservable(t);var i=e;if(f(e)){var s=2;i={},i._get=e,f(n)&&(i._set=n,s++),i.deps=u.slice.call(arguments,s)}return this.obs[t]=new m(this,t,i),this},hasObservable:function(t){return this.obs.hasOwnProperty(t)},removeObservable:function(t){return this.hasObservable(t)&&(this.obs[t].dispose(),delete this.obs[t]),this},clearObservables:function(){for(var t in this.obs)this.removeObservable(t);return this},modifyArray:function(t,e){var n=this.get(t);if(v(n)&&f(u[e])){var i=u.slice.call(arguments,2),s=u[e].apply(n,i);return this.trigger("change change:"+t),s}return null},modifyObject:function(t,e,n){var i=this.get(t),s=!1;return d(i)?(l(n)&&i.hasOwnProperty(e)?(delete i[e],s=!0):i[e]!==n&&(i[e]=n,s=!0),s&&this.trigger("change change:"+t),i):null}});var m=function(e,n,i){i=i||{},i.get&&f(i.get)&&(i._get=i.get),i.set&&f(i.set)&&(i._set=i.set),delete i.get,delete i.set,t.extend(this,i),this.model=e,this.name=n,this.deps=this.deps||[],e._init||this.init()};t.extend(m.prototype,e.Events,{init:function(){if(c=this.deps,this.get(!0),c=null,this.deps.length){var e={};t.each(this.deps,function(n){var i=this.model;v(n)&&(i=n[1],n=n[0]),n.indexOf("change:")&&(n="change:"+n),e.hasOwnProperty(n)?t.contains(e[n],i)||e[n].push(i):e[n]=[i]},this),t.each(e,function(e,n){for(var i=0,s=e.length;s>i;i++)this.listenTo(e[i],n,t.bind(this.get,this,!0))},this)}},get:function(t){if(t===!0&&this._get){var e=this._get.call(this.model);this.change(e)}return this.value},set:function(t){if(this._get){if(this._set)return this._set.apply(this.model,arguments);throw"Cannot set read-only computed observable."}return this.change(t),null},fire:function(){this.model.trigger("change change:"+this.name)},change:function(e){t.isEqual(e,this.value)||(this.value=e,this.fire())},dispose:function(){this.stopListening(),this.off(),this.model=this.value=null}});var y,w=i(e.View);h.View=e.View.extend({constructor:function(){this._bind=[],w(this,"constructor",arguments),this.applyBindings()},bindings:"data-bind",applyBindings:function(){function e(t,e,i){try{n._bind.push(new B(t,e,a,r))}catch(s){throw'Error parsing bindings for "'+i+'" >> '+s}}if(this.removeBindings(),this.model||this.collection||this.bindingSources){var n=this,i=n.bindingSources,s=n.bindings,r=t.clone(O),a={};if(t.each(n.bindingHandlers||{},function(t,e){r[e]=f(t)?{set:t}:t}),n.model=o(n.model,a),n.collection=o(n.collection,a),t.each(i,function(t,e){i[e]=o(t,a,e)}),d(s))t.each(s,function(t,n){var i=this.$(n);this.$el.is(n)&&(i=i.add(this.$el)),i.length&&e(i,t,n)},this);else{var c="["+s+"]",h=this.$(c);this.$el.is(c)&&(h=h.add(this.$el)),h.each(function(t){t=$(this),e(t,t.attr(s),c)})}}},removeBindings:function(){for(;this._bind.length;)this._bind.pop().dispose()},remove:function(){this.removeBindings(),w(this,"remove")}});var O={attr:{set:function(t,e){t.attr(e)}},checked:{get:function(e,n){var i=!!e.prop("checked"),s=e.val();if(e.is(":radio"))return s;if(v(n)){n=n.slice();var o=t.indexOf(n,s);return i&&0>o?n.push(s):!i&&o>-1&&n.splice(o,1),n}return i},set:function(e,n){var i=!!n;e.is(":radio")?i=n==e.val():v(n)&&(i=t.contains(n,e.val())),e.prop("checked",i)}},classes:{set:function(e,n){t.each(n,function(t,n){e.toggleClass(n,!!t)})}},collection:{set:function(e,n,i){if(!p(n)||!f(n.view))throw"Binding 'collection' requires a Collection with a 'view' constructor.";var s,o=n.models,r=this.v;if(i=i||n,g(i))if(r.hasOwnProperty(i.cid))s=r[i.cid],s.remove(),delete r[i.cid];else{r[i.cid]=s=new n.view({model:i});var a=t.indexOf(o,i);a>e.children().length?e.eq(a).before(s.$el):e.append(s.$el)}else if(p(i)){var c=o.length&&t.every(o,function(t){return r.hasOwnProperty(t.cid)});e.hide(),c?n.each(function(t){e.append(r[t.cid].$el)}):(this.empty(),n.each(function(t){r[t.cid]=s=new n.view({model:t}),e.append(s.$el)})),e.show()}}},css:{set:function(t,e){t.css(e)}},disabled:{set:function(t,e){t.prop("disabled",!!e)}},enabled:{set:function(t,e){t.prop("disabled",!e)}},html:{set:function(t,e){t.html(e)}},options:{set:function(e,n){var i=r(this.optionsEmpty),s=r(this.optionsDefault),o=p(n)?n.models:n;if(!v(o))throw"Binding 'options' requires a list value.";var c=e.val(),h=!0,u="";o.length||s||!i?(s&&(u+=a(s)),t.each(o,function(t){u+=a(t)})):(u+=a(i),h=!1),e.html(u).prop("disabled",!h).val(c),t.isEqual(e.val(),c)||e.trigger("change")}},text:{set:function(t,e){t.text(e)}},toggle:{set:function(t,e){t.toggle(!!e)}},value:{get:function(t){return t.val()},set:function(t,e){t.val()!=e&&t.val(e)}}},x=function(t){return function(){var e=arguments;return function(){return t(e)}}},_={all:x(function(t){for(var e=!0,n=0,i=t.length;i>n;n++)r(t[n])||(e=!1);return e}),any:x(function(t){for(var e=!1,n=0,i=t.length;i>n;n++)r(t[n])&&(e=!0);return e}),length:x(function(t){return r(t[0]).length||0}),none:x(function(t){for(var e=!0,n=0,i=t.length;i>n;n++)r(t[n])&&(e=!1);return e}),not:x(function(t){return!r(t[0])}),format:x(function(t){for(var e=r(t[0]),n=1,i=t.length;i>n;n++)e=e.replace(RegExp("\\$"+n,"g"),r(t[n]));return e}),select:x(function(t){var e=r(t[0]),n=r(t[1]),i=r(t[2]);return e?n:i})},E=["events","optionsDefault","optionsEmpty"],B=function(e,n,i,s){this.$el=e,this.v={};var o=this,a=e[0].tagName.toLowerCase(),c="input"==a||"select"==a||"textarea"==a,h=Function("$o","$c","with($o){with($c){return{"+n+"}}}");n=h(_,i),t.each(E,function(t){o[t]=n[t],delete n[t]}),this.events=t.map(t.union(this.events||[],["change"]),function(t){return t+".epoxy"}).join(" "),t.each(n,function(t,e){if(!s.hasOwnProperty(e))throw"invalid binding => "+e;var n=s[e],i=[],a=function(e){n.set.call(o,o.$el,r(t),e)};if(y=i,a(),y=null,c&&n.get&&f(t)&&o.$el.on(o.events,function(){t(n.get.call(o,o.$el,r(t)))}),i.length)for(var h=0,u=i.length;u>h;h++)o.listenTo(i[h][0],i[h][1],a)})};return t.extend(B.prototype,e.Events,{empty:function(){for(var t in this.v)this.v.hasOwnProperty(t)&&(this.v[t].remove(),delete this.v[t])},dispose:function(){this.empty(),this.stopListening(),this.$el.off(this.events),this.$el=null}}),h});